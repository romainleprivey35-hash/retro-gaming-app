<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Retro Collection</title>
    <style>
        :root { --neon: #00ff88; --bg: #0a0a0a; --card: #161616; }
        
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }

        /* Header Fixe et propre */
        header { 
            height: 60px; background: #000; display: flex; align-items: center; 
            justify-content: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222;
        }
        #back-btn { position: absolute; left: 15px; background: #222; border: none; color: white; padding: 8px 15px; border-radius: 8px; display: none; font-size: 0.9rem; }
        h1 { font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; margin: 0; color: var(--neon); }

        /* Grille identique pour tout l'appli */
        .grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; 
            animation: fadeIn 0.3s ease-in-out;
        }

        .card { 
            background: var(--card); border-radius: 15px; padding: 12px; text-align: center;
            border: 1px solid #222; transition: 0.3s;
        }
        .card:active { transform: scale(0.95); border-color: var(--neon); }

        .img-box { 
            width: 100%; height: 140px; display: flex; align-items: center; 
            justify-content: center; background: #000; border-radius: 10px; overflow: hidden; 
        }
        .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .title { font-weight: bold; font-size: 0.85rem; margin-top: 10px; text-transform: uppercase; color: #eee; }
        .price { color: var(--neon); font-weight: bold; margin-top: 5px; font-size: 1.1rem; }
        
        /* √âtat "Non Poss√©d√©" */
        .not-owned { opacity: 0.25; filter: grayscale(100%); }

        /* Nav Basse */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; 
            border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center;
        }
        .nav-link { text-align: center; color: #666; font-size: 0.75rem; text-decoration: none; }
        .nav-link.active { color: var(--neon); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <button id="back-btn" onclick="handleBack()">‚óÄ Retour</button>
    <h1 id="header-title">Retro App</h1>
</header>

<div id="main-grid" class="grid">
    </div>

<nav class="bottom-nav">
    <div class="nav-link active" onclick="goHome()">üè†<br>Accueil</div>
    <div class="nav-link" onclick="alert('Statistiques bient√¥t disponibles')">üìä<br>Stats</div>
</nav>

<script>
    const SHEET_ID = '1Vw439F_75oc7AcxkDriWi_fwX2oBbAejnp-f_Puw-FU';
    let currentBrand = '';
    let currentStep = 'brands'; // brands, categories, items

    function formatImg(url) {
        if (!url || !url.includes('id=')) return url;
        const id = url.split('id=')[1].split('&')[0];
        return `https://drive.google.com/thumbnail?id=${id}&sz=w500`;
    }

    async function fetchSheet(tabName) {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${tabName}`;
        const res = await fetch(url);
        const text = await res.text();
        return JSON.parse(text.substr(47).slice(0, -2)).table.rows;
    }

    // VUE 1 : MARQUES (Depuis onglet Menu)
    async function showBrands() {
        currentStep = 'brands';
        document.getElementById('back-btn').style.display = 'none';
        document.getElementById('header-title').innerText = "Retro App";
        const container = document.getElementById('main-grid');
        container.innerHTML = "Chargement...";

        const rows = await fetchSheet('Menu');
        let html = '';
        rows.forEach(row => {
            const name = row.c[0]?.v;
            const img = formatImg(row.c[1]?.v);
            if(name) {
                html += `
                    <div class="card" onclick="selectBrand('${name}')">
                        <div class="img-box"><img src="${img}"></div>
                        <div class="title">${name}</div>
                    </div>`;
            }
        });
        container.innerHTML = html;
    }

    // VUE 2 : CATEGORIES (Depuis onglet Categories)
    async function showCategories() {
        currentStep = 'categories';
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('header-title').innerText = currentBrand;
        const container = document.getElementById('main-grid');
        container.innerHTML = "Chargement...";

        const rows = await fetchSheet('Categories');
        let html = '';
        rows.forEach(row => {
            const name = row.c[0]?.v;
            const img = formatImg(row.c[1]?.v);
            if(name) {
                html += `
                    <div class="card" onclick="selectCategory('${name}')">
                        <div class="img-box"><img src="${img}"></div>
                        <div class="title">${name}</div>
                    </div>`;
            }
        });
        container.innerHTML = html;
    }

    // VUE 3 : ARTICLES (Filtr√©s)
    async function showItems(category) {
        currentStep = 'items';
        document.getElementById('header-title').innerText = category;
        const container = document.getElementById('main-grid');
        container.innerHTML = "Chargement...";

        const rows = await fetchSheet(category);
        let html = '';
        rows.forEach(row => {
            const title = row.c[0]?.v;
            const brand = row.c[1]?.v || '';
            const img = formatImg(row.c[6]?.v);
            const price = row.c[12]?.v || '--';
            const owned = row.c[14]?.v || '';

            if(brand.toLowerCase().includes(currentBrand.toLowerCase())) {
                html += `
                    <div class="card ${owned.includes('Oui') ? '' : 'not-owned'}">
                        <div class="img-box"><img src="${img}"></div>
                        <div class="title">${title}</div>
                        <div class="price">${price} ‚Ç¨</div>
                    </div>`;
            }
        });
        container.innerHTML = html || "<p style='grid-column: 1/3; text-align:center;'>Aucun article trouv√©.</p>";
    }

    function selectBrand(name) {
        currentBrand = name;
        showCategories();
    }

    function selectCategory(cat) {
        showItems(cat);
    }

    function handleBack() {
        if(currentStep === 'items') showCategories();
        else if(currentStep === 'categories') showBrands();
    }

    function goHome() {
        showBrands();
    }

    // Lancement
    showBrands();
</script>
</body>
</html>
