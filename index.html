<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Retro App</title>
    <style>
        body { background: #000; color: white; font-family: sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        #back-btn { position: absolute; left: 10px; background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; display: none; }
        h1 { font-size: 1.2rem; color: #00ff88; text-transform: uppercase; margin: 0; }

        .content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }

        /* Style des 3 blocs */
        .full-btn { 
            flex: 1; min-height: 200px; position: relative; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #222; background-size: cover; background-position: center; text-decoration: none; color: white;
        }
        .full-btn::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
        .full-btn span { position: relative; z-index: 2; font-size: 2rem; font-weight: bold; text-transform: uppercase; }

        /* Style de la grille finale */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: #111; border-radius: 10px; padding: 10px; border: 1px solid #333; text-align: center; }
        .card img { max-width: 100%; height: 140px; object-fit: contain; }
        .not-owned { opacity: 0.2; filter: grayscale(1); }
        .price { color: #00ff88; font-weight: bold; margin-top: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <button id="back-btn" onclick="goBack()">◀</button>
    <h1 id="title">RETRO APP</h1>
</header>

<div id="view-brands" class="content"></div>
<div id="view-categories" class="content hidden"></div>
<div id="view-list" class="content hidden"><div id="list-grid" class="grid"></div></div>

<script>
    const SHEET_ID = '1Vw439F_75oc7AcxkDriWi_fwX2oBbAejnp-f_Puw-FU';
    let brand = '';
    let step = 'brands';

    function getDriveImg(url) {
        if (!url) return '';
        if (url.includes('id=')) {
            const id = url.split('id=')[1].split('&')[0];
            return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
        }
        return url;
    }

    async function loadSheet(tab) {
        try {
            const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`);
            const text = await response.text();
            const data = JSON.parse(text.substr(47).slice(0, -2));
            return data.table.rows;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function initBrands() {
        const rows = await loadSheet('Menu');
        let html = '';
        rows.forEach(r => {
            const name = r.c[0]?.v;
            const img = getDriveImg(r.c[1]?.v);
            if(name) html += `<div class="full-btn" style="background-image:url('${img}')" onclick="pickBrand('${name}')"><span>${name}</span></div>`;
        });
        document.getElementById('view-brands').innerHTML = html || "Erreur de chargement.";
    }

    async function initCategories() {
        const rows = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Categories`)
            .then(r => r.text()).then(t => JSON.parse(t.substr(47).slice(0, -2))).then(d => d.table.rows);
        
        let html = '';
        rows.forEach(r => {
            const name = r.c[0]?.v;
            const img = getDriveImg(r.c[1]?.v);
            if(name) html += `<div class="full-btn" style="background-image:url('${img}')" onclick="pickCategory('${name}')"><span>${name}</span></div>`;
        });
        document.getElementById('view-categories').innerHTML = html;
    }

    function pickBrand(b) {
        brand = b; step = 'categories';
        render();
        initCategories();
    }

    function pickCategory(c) {
        step = 'list';
        render();
        loadItems(c);
    }

    async function loadItems(c) {
        const grid = document.getElementById('list-grid');
        grid.innerHTML = "Chargement...";
        const rows = await loadSheet(c);
        let html = '';
        rows.forEach(r => {
            const name = r.c[0]?.v || '';
            const b = r.c[1]?.v || '';
            const img = getDriveImg(r.c[6]?.v);
            const pr = r.c[12]?.v || '--';
            const ow = r.c[14]?.v || '';

            if(b.toLowerCase().includes(brand.toLowerCase())) {
                html += `<div class="card ${ow.includes('Oui') ? '' : 'not-owned'}">
                    <img src="${img}">
                    <div style="font-size:0.8rem; margin:5px 0;">${name}</div>
                    <div class="price">${pr} €</div>
                </div>`;
            }
        });
        grid.innerHTML = html || "Aucun jeu trouvé.";
    }

    function goBack() {
        if(step === 'list') step = 'categories';
        else if(step === 'categories') step = 'brands';
        render();
    }

    function render() {
        document.getElementById('view-brands').classList.toggle('hidden', step !== 'brands');
        document.getElementById('view-categories').classList.toggle('hidden', step !== 'categories');
        document.getElementById('view-list').classList.toggle('hidden', step !== 'list');
        document.getElementById('back-btn').style.display = (step === '
